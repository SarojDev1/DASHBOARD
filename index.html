<!DOCTYPE html>
<html>
<head>
    <title>SAROJ PRODUCTION PANEL</title>
    <style>
        body { font-family: Arial; background: #0d0d0d; color: white; text-align: center; }
        #loginBox, #callBox { margin-top: 40px; }
        input { padding: 10px; width: 260px; margin: 6px; border-radius: 6px; border: none; }
        button { padding: 10px 20px; border: none; background: #7b2cff; color: white; border-radius: 6px; cursor: pointer; }
        .videoContainer { display: inline-block; position: relative; margin:10px; }
        video { width: 45%; border-radius: 6px; background: black; }
        .muteOverlay {
            position: absolute;
            top: 5px; left: 5px;
            background: red;
            color: white;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            display: none;
            z-index: 10;
        }
        #controls button { margin: 5px; }
    </style>
</head>
<body>

<h1>SAROJ PRODUCTION PANEL</h1>
<h3>Admin + Teams | Video Call | Screen Share | Mute | Camera</h3>

<!-- LOGIN -->
<div id="loginBox">
    <h2>Login</h2>
    <input id="username" placeholder="Enter username"><br>
    <input id="password" type="password" placeholder="Enter password (Admin only)"><br>
    <button onclick="login()">Login</button>
</div>

<!-- CALL -->
<div id="callBox" style="display:none;">
    <h2>Connected to: production-room</h2>

    <div class="videoContainer">
        <video id="localVideo" autoplay playsinline muted></video>
        <div id="muteOverlay" class="muteOverlay">MUTED</div>
    </div>

    <div class="videoContainer">
        <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div id="controls">
        <button onclick="toggleMic()">Mute / Unmute</button>
        <button onclick="toggleCam()">Camera On / Off</button>
        <button onclick="startScreen()">Share Screen</button>
    </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
//////////////////////////////////
// FIREBASE CONFIG
//////////////////////////////////
const firebaseConfig = {
  apiKey: "AIzaSyAHmfSYuO4kZesR1olmDxEYEYe3kXl0q_Y",
  authDomain: "business-bfddf.firebaseapp.com",
  projectId: "business-bfddf",
  storageBucket: "business-bfddf.firebasestorage.app",
  messagingSenderId: "536592740939",
  appId: "1:536592740939:web:a59d16003542ee3b7b53ce",
  measurementId: "G-7HJWD72M12"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

//////////////////////////////////
// GLOBAL VARIABLES
//////////////////////////////////
const roomName = "production-room";
let pc;
let localStream;
let remoteStream;
let micEnabled = true;
let camEnabled = true;

//////////////////////////////////
// LOGIN
//////////////////////////////////
function login() {
    let user = document.getElementById("username").value;
    let pass = document.getElementById("password").value;

    if (user === "admin" && pass === "12345") {
        startCall();
    } else if (user !== "" && pass === "") {
        startCall();
    } else {
        alert("Wrong login!");
        return;
    }

    document.getElementById("loginBox").style.display = "none";
    document.getElementById("callBox").style.display = "block";
}

//////////////////////////////////
// START VIDEO CALL
//////////////////////////////////
async function startCall() {
    localStream = await navigator.mediaDevices.getUserMedia({
        video: { width: { ideal: 3840 }, height: { ideal: 2160 }, frameRate: { ideal: 30 } },
        audio: true
    });
    document.getElementById("localVideo").srcObject = localStream;

    pc = new RTCPeerConnection({ iceServers: [{ urls: ["stun:stun.l.google.com:19302"] }] });

    remoteStream = new MediaStream();
    document.getElementById("remoteVideo").srcObject = remoteStream;

    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    pc.ontrack = event => {
        event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
    };

    pc.onicecandidate = event => {
        if (event.candidate) {
            db.collection(roomName).doc("candidates").collection("all").add(event.candidate.toJSON());
        }
    };

    // OFFER
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await db.collection(roomName).doc("offer").set({ type: "offer", sdp: offer.sdp });

    // ANSWER
    db.collection(roomName).doc("answer").onSnapshot(async snapshot => {
        if (snapshot.exists) {
            let answer = snapshot.data();
            if (!pc.currentRemoteDescription) {
                await pc.setRemoteDescription(new RTCSessionDescription(answer));
            }
        }
    });

    // ICE CANDIDATES
    db.collection(roomName).doc("candidates").collection("all").onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
            if (change.type === "added") {
                let data = change.doc.data();
                pc.addIceCandidate(new RTCIceCandidate(data));
            }
        });
    });
}

//////////////////////////////////
// CONTROLS
//////////////////////////////////
function toggleMic() {
    micEnabled = !micEnabled;
    localStream.getAudioTracks()[0].enabled = micEnabled;
    document.getElementById("muteOverlay").style.display = micEnabled ? "none" : "block";
}

function toggleCam() {
    camEnabled = !camEnabled;
    localStream.getVideoTracks()[0].enabled = camEnabled;
}

async function startScreen() {
    try {
        const screenStream = await navigator.mediaDevices.getDisplayMedia({
            video: { width: { ideal: 3840 }, height: { ideal: 2160 }, frameRate: { ideal: 30 } }
        });
        const screenTrack = screenStream.getTracks()[0];
        const sender = pc.getSenders().find(s => s.track.kind === "video");
        sender.replaceTrack(screenTrack);
        screenTrack.onended = () => {
            sender.replaceTrack(localStream.getVideoTracks()[0]);
        };
    } catch(err) {
        alert("Screen share failed: " + err);
    }
}
</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <title>SAROJ PRODUCTION | Video Call</title>
    <style>
        body { background:#0d0d0d; color:white; font-family:Arial; text-align:center; }
        #loginBox { margin-top:50px; }
        #callBox { display:none; }

        input { padding:10px; width:250px; border-radius:6px; border:none; margin:6px; }
        button { padding:10px 20px; background:#7b2cff; border:none; border-radius:6px; color:white; cursor:pointer; }

        #videos { 
            display:grid; 
            grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));
            gap:10px; margin-top:20px;
        }

        .vbox { 
            position:relative; 
            background:#000; 
            border-radius:6px; 
        }

        video { width:100%; height:auto; border-radius:6px; }

        .muteIcon {
            position:absolute;
            top:5px; left:5px;
            background:red; color:white;
            padding:4px 8px;
            border-radius:4px;
            display:none;
            font-size:14px;
        }

        .shareNotice {
            position:fixed;
            top:10px; right:10px;
            background:#7b2cff; padding:10px 15px;
            border-radius:6px; z-index:9999;
        }
    </style>
</head>
<body>

<h1>SAROJ PRODUCTION MULTI MANAGEMENT</h1>

<div id="loginBox">
    <input id="username" placeholder="Enter your name"><br>
    <input id="password" placeholder="Password (12345)" type="password"><br>
    <button onclick="login()">Join Room</button>
</div>

<div id="callBox">
    <button onclick="toggleMic()">Mute / Unmute</button>
    <button onclick="toggleCam()">Camera On / Off</button>
    <button id="screenBtn" onclick="shareScreen()">Share Screen</button>

    <div id="videos"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
/*** FIREBASE CONFIG ***/
const firebaseConfig = {
  apiKey: "AIzaSyAHmfSYuO4kZesR1olmDxEYEYe3kXl0q_Y",
  authDomain: "business-bfddf.firebaseapp.com",
  projectId: "business-bfddf",
  storageBucket: "business-bfddf.firebasestorage.app",
  messagingSenderId: "536592740939",
  appId: "1:536592740939:web:a59d16003542ee3b7b53ce",
  measurementId: "G-7HJWD72M12"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();


/*** GLOBALS ***/
let localId;
let localStream;
let micEnabled = true;
let camEnabled = true;
let peers = {};      // userId → RTCPeerConnection
let remoteBoxes = {}; // userId → HTML video box

const room = "mainRoom12345"; // ALL users join SAME ROOM


/*** LOGIN ***/
function login() {
    const user = document.getElementById("username").value;
    const pass = document.getElementById("password").value;

    if (!user) return alert("Enter name");
    if (pass !== "12345") return alert("Wrong password");

    localId = user + "_" + Date.now();

    document.getElementById("loginBox").style.display = "none";
    document.getElementById("callBox").style.display = "block";

    startCall();
}


/*** START CALL ***/
async function startCall() {
    localStream = await navigator.mediaDevices.getUserMedia({
        video: { width: 1280, height: 720 },
        audio: true
    });

    addVideoBox(localId, localStream, true);

    db.collection(room).doc(localId).set({ id: localId, live: true });

    listenForUsers();
    listenForOffers();
    listenForAnswers();
    listenForCandidates();
}


/*** ADD VIDEO BOX ***/
function addVideoBox(id, stream, isLocal = false) {
    if (remoteBoxes[id]) remoteBoxes[id].remove();

    const box = document.createElement("div");
    box.className = "vbox";

    const video = document.createElement("video");
    video.autoplay = true;
    video.playsInline = true;
    video.srcObject = stream;
    if (isLocal) video.muted = true;

    const muteIcon = document.createElement("div");
    muteIcon.className = "muteIcon";
    muteIcon.innerText = "MUTED";

    box.appendChild(video);
    box.appendChild(muteIcon);

    document.getElementById("videos").appendChild(box);

    remoteBoxes[id] = box;
}


/*** REMOVE USER BOX WHEN LEAVE ***/
db.collection(room).onSnapshot(snap => {
    snap.docChanges().forEach(change => {
        if (change.type === "removed") {
            const uid = change.doc.id;
            if (remoteBoxes[uid]) {
                remoteBoxes[uid].remove();
                delete remoteBoxes[uid];
            }
            if (peers[uid]) {
                peers[uid].close();
                delete peers[uid];
            }
        }
    });
});


/*** LISTEN USERS JOINING ***/
function listenForUsers() {
    db.collection(room).onSnapshot(snap => {
        snap.forEach(doc => {
            const uid = doc.data().id;
            if (uid !== localId && !peers[uid]) {
                createPeer(uid);
                sendOffer(uid);
            }
        });
    });
}


/*** CREATE PEER ***/
function createPeer(uid) {
    const pc = new RTCPeerConnection({
        iceServers: [{ urls: ["stun:stun.l.google.com:19302"] }]
    });

    peers[uid] = pc;

    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    pc.ontrack = (e) => {
        addVideoBox(uid, e.streams[0]);
    };

    pc.onicecandidate = (e) => {
        if (e.candidate) {
            db.collection(room).doc(localId + "_ice_" + uid).set({
                from: localId,
                to: uid,
                candidate: e.candidate.toJSON()
            });
        }
    };
}


/*** SEND OFFER ***/
async function sendOffer(uid) {
    const pc = peers[uid];
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    db.collection(room).doc(localId + "_offer_" + uid).set({
        from: localId,
        to: uid,
        sdp: offer.sdp
    });
}


/*** LISTEN FOR OFFERS ***/
function listenForOffers() {
    db.collection(room).where("to", "==", localId).onSnapshot(snap => {
        snap.docChanges().forEach(async change => {
            if (change.type === "added" && change.doc.id.includes("_offer_")) {
                const data = change.doc.data();
                const from = data.from;

                if (!peers[from]) createPeer(from);

                await peers[from].setRemoteDescription({
                    type: "offer",
                    sdp: data.sdp
                });

                const answer = await peers[from].createAnswer();
                await peers[from].setLocalDescription(answer);

                db.collection(room).doc(localId + "_answer_" + from).set({
                    from: localId,
                    to: from,
                    sdp: answer.sdp
                });
            }
        });
    });
}


/*** LISTEN FOR ANSWERS ***/
function listenForAnswers() {
    db.collection(room).where("to", "==", localId).onSnapshot(snap => {
        snap.docChanges().forEach(async change => {
            if (change.type === "added" && change.doc.id.includes("_answer_")) {
                const data = change.doc.data();
                const from = data.from;

                await peers[from].setRemoteDescription({
                    type: "answer",
                    sdp: data.sdp
                });
            }
        });
    });
}


/*** LISTEN FOR ICE CANDIDATES ***/
function listenForCandidates() {
    db.collection(room).where("to", "==", localId).onSnapshot(snap => {
        snap.docChanges().forEach(async change => {
            if (change.type === "added" && change.doc.id.includes("_ice_")) {
                const data = change.doc.data();
                const from = data.from;

                if (peers[from]) {
                    await peers[from].addIceCandidate(data.candidate);
                }
            }
        });
    });
}


/*** MUTE MIC ***/
function toggleMic() {
    micEnabled = !micEnabled;
    localStream.getAudioTracks()[0].enabled = micEnabled;

    remoteBoxes[localId].querySelector(".muteIcon").style.display =
        micEnabled ? "none" : "block";
}


/*** CAMERA ON/OFF ***/
function toggleCam() {
    camEnabled = !camEnabled;
    localStream.getVideoTracks()[0].enabled = camEnabled;
}


/*** SCREEN SHARE ***/
async function shareScreen() {
    if (!navigator.mediaDevices.getDisplayMedia) {
        return alert("Screen share only works on PC Chrome/Edge/Firefox.");
    }

    try {
        const screen = await navigator.mediaDevices.getDisplayMedia({
            video: true
        });

        showShareNotice("You are sharing your screen");

        const track = screen.getTracks()[0];

        Object.values(peers).forEach(pc => {
            const sender = pc.getSenders().find(s => s.track.kind === "video");
            sender.replaceTrack(track);
        });

        remoteBoxes[localId].querySelector("video").srcObject = screen;

        track.onended = () => {
            Object.values(peers).forEach(pc => {
                const sender = pc.getSenders().find(s => s.track.kind === "video");
                sender.replaceTrack(localStream.getVideoTracks()[0]);
            });

            remoteBoxes[localId].querySelector("video").srcObject = localStream;
        };

    } catch (e) {
        alert("Screen share failed: " + e);
    }
}


/*** SHOW NOTIFICATION ***/
function showShareNotice(msg) {
    const d = document.createElement("div");
    d.className = "shareNotice";
    d.innerText = msg;
    document.body.appendChild(d);
    setTimeout(() => d.remove(), 3000);
}
</script>

</body>
</html>
